<div class="agenda-container">
    <mat-card class="date-header-card">
        <mat-card-header>
            <mat-icon mat-card-avatar color="primary">calendar_today</mat-icon>
            <mat-card-title>Gestión de Agenda</mat-card-title>
            <mat-card-subtitle>Define tus horarios de atención.</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Seleccionar Día</mat-label>
                <input matInput [matDatepicker]="picker" [value]="selectedDate"
                    (dateChange)="loadHorarios($event.value)" readonly />
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>
        </mat-card-content>
    </mat-card>

    <mat-card *ngIf="rangosGuardados.length > 0" class="horarios-card">
        <mat-card-title class="center-text">Horarios registrados</mat-card-title>
        <table mat-table [dataSource]="rangosGuardados" class="mat-elevation-z8 full-width-table">
            <ng-container matColumnDef="horaEntrada">
                <th mat-header-cell *matHeaderCellDef>Inicio</th>
                <td mat-cell *matCellDef="let r">
                    {{ formatHora(r.horaEntrada).split(' ')[0] }}
                    <span class="ampm-suffix">{{ formatHora(r.horaEntrada).split(' ')[1] }}</span>
                </td>
            </ng-container>

            <ng-container matColumnDef="horaSalida">
                <th mat-header-cell *matHeaderCellDef>Fin</th>
                <td mat-cell *matCellDef="let r">
                    {{ formatHora(r.horaSalida).split(' ')[0] }}
                    <span class="ampm-suffix">{{ formatHora(r.horaSalida).split(' ')[1] }}</span>
                </td>
            </ng-container>

            <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let r">
                    <button mat-icon-button color="warn" (click)="eliminarRango(r.id)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['horaEntrada', 'horaSalida', 'acciones']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['horaEntrada', 'horaSalida', 'acciones']"></tr>
        </table>
    </mat-card>

    <form *ngIf="mostrarFormulario" [formGroup]="agendaForm" (ngSubmit)="guardarAgenda()">
        <mat-card class="horarios-card">
            <mat-card-title class="center-text">Nuevo horario</mat-card-title>
            <mat-card-content formArrayName="horarios">
                <div *ngFor="let r of horarios.controls; let i = index" [formGroupName]="i" class="rango-form-row">
                    
                    <mat-form-field appearance="outline" class="time-field">
                        <mat-label>Hora inicio</mat-label>
                        <input 
                            matInput 
                            [ngxTimepicker]="pickerEntrada" 
                            formControlName="horaEntrada" 
                            readonly 
                            [format]="24" 
                            />
                        
                        <mat-icon 
                            matPrefix
                            *ngIf="r.get('horaEntrada')?.value"
                            (click)="limpiarControl(r.get('horaEntrada')); $event.stopPropagation()"
                            >close</mat-icon>

                        <ngx-material-timepicker-toggle matSuffix [for]="pickerEntrada"></ngx-material-timepicker-toggle>
                        <ngx-material-timepicker #pickerEntrada></ngx-material-timepicker>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="time-field">
                        <mat-label>Hora fin</mat-label>
                        <input 
                            matInput 
                            [ngxTimepicker]="pickerSalida" 
                            formControlName="horaSalida" 
                            readonly 
                            [format]="24" 
                            />
                        
                        <mat-icon 
                            matPrefix
                            *ngIf="r.get('horaSalida')?.value"
                            (click)="limpiarControl(r.get('horaSalida')); $event.stopPropagation()"
                            >close</mat-icon>
                            
                        <ngx-material-timepicker-toggle matSuffix [for]="pickerSalida"></ngx-material-timepicker-toggle>
                        <ngx-material-timepicker #pickerSalida></ngx-material-timepicker>
                    </mat-form-field>
                </div>
            </mat-card-content>

            <mat-card-actions class="card-actions">
                <button mat-flat-button color="primary" type="submit" [disabled]="agendaForm.invalid">
                    <mat-icon>save</mat-icon> Guardar
                </button>
                <button mat-flat-button color="warn" type="button" (click)="toggleFormulario()">
                    <mat-icon>close</mat-icon> Cancelar
                </button>
            </mat-card-actions>
        </mat-card>
    </form>

    <div class="center-btn">
        <button mat-flat-button color="accent" type="button" (click)="toggleFormulario()">
            <mat-icon>add</mat-icon> Añadir horario
        </button>
    </div>
</div>